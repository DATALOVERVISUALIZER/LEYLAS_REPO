<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Sankey Diagram</title>
  <style>

    body {
      font-family: sans-serif;
    }

    .node rect {
      fill-opacity: .9;
      shape-rendering: crispEdges;
    }
	
    .nodeSelect {
      fill: none;
      stroke: #024;
      stroke-opacity: .5;
    }

    .link {
      fill: none;
      stroke: #024;
      stroke-opacity: .2;
    }

    .link:hover {
      stroke-opacity: .5;
    }

    .link.backwards {
      stroke: #402;
      stroke-dasharray: 9,1;
    }
	
	#chart {
	  font: 13px sans-serif;
	}
	
	#theFile {
		position: fixed;
		top: 0;
		left: 0;
		padding: 0;
	}

  </style>
</head>
<body>

<div id="data-set-select"></div>
<div id="chart"></div>

<script src="js/d3.v3.min.js" charset="utf-8"></script>
<script src="js/sankey-bigloop.js"></script>
<script>


  // Some setup stuff.
  var margin = {top: 15, right: 90, bottom: 5, left: 10};
  var width = 1300 - margin.left - margin.right;
  var height = 650 - margin.top - margin.bottom;
  var color = d3.scale.category20();

  // SVG (group) to draw in.
  var svg = d3.select("#chart").append("svg")
          .attr({
            width: width + margin.left + margin.right,
            height: height + margin.top + margin.bottom
          })
          .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  var linksGroup = svg.append("g").attr('class', 'links');
  var nodesGroup = svg.append("g").attr('class', 'nodes');

  // Set up Sankey object.
  var sankey = d3.sankey()
          .nodeWidth(15)
          .nodePadding(10)
          .size([width, height]);

  // Get path data generator
  var path = sankey.link();


  // Callback to draw on a data set.
  function sankeyDraw(data) {

    sankey.nodes(data.nodes)
            .links(data.links)
            .sinksRight('sinksRight' in data ? data.sinksRight : true)
            .layout(32);

    // Draw the links.
    var links = linksGroup.selectAll('.link').data(data.links);
    // Enter
    links.enter()
            .append("path")
            .attr('class', 'link');
	//console.log("hey")
    // Enter + Update
    links.attr('d', path)
            .style("stroke-width", function (d) {
              return Math.max(1, d.dy);
            });
    links.classed('backwards', function (d) { return d.target.x < d.source.x; });

    links.append("title")
            .text(function (d) {
              return d.source.name + " ->\n " + d.target.name + "\n = " + d.value;
            });
    // Exit
    links.exit().remove();

    // Draw the nodes.
    var nodes = nodesGroup.selectAll('.node').data(data.nodes);
    // Enter
    var nodesEnterSelection = nodes.enter()
            .append("g")
            .attr('class', 'node')
	.call(d3.behavior.drag()
      .origin(function(d) { return d; })
      .on("dragstart", function() { this.parentNode.appendChild(this); })
      .on("drag", dragmove))
	  .on("mouseover", function(e) {
		//console.log(e)
		links.attr("class", function(l) {
			//console.log(l)
			//console.log(e.targetLinks)
			
			if(l.source.id == e.id || l.target.id == e.id) {
				//console.log(l.source) //.on("mouseover")();
				return 'nodeSelect';
			}
			return 'link';
		});

	  })
	  .on("mouseout",  function(e) { links.attr("class", 'link'); });
    nodesEnterSelection.append("rect")
            .attr('width', sankey.nodeWidth())
            .append("title");
    nodesEnterSelection.append("text")
            .attr('x', sankey.nodeWidth() / 2)
            .attr('dy', ".35em")
			.attr('dx', ".70em")
            .attr("text-anchor", "left") // middle
            .attr('transform', null);

    // Enter + Update
    nodes
            .attr('transform', function (d) {
              return "translate(" + d.x + "," + d.y + ")";
            });
    nodes.select('rect')
            .attr('height', function (d) {
              return d.dy;
            })
            .style('fill', function (d) {
              return d.color = color(d.name);
            })
            .style('stroke', function (d) {
              return d3.rgb(d.color).darker(2);
            });
    nodes.select('rect').select('title')
            .text(function (d) {
              return d.name;
            });
    nodes.select('text')
            .attr('y', function (d) {
              return d.dy / 2;
            })
            .text(function (d) {
              return d.name;
            });
			
  function dragmove(d) {
    d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
    sankey.relayout();
    links.attr("d", path);
  }
			
			
    // Exit
    nodes.exit().remove();

  }

/*
sankeyDraw(
  {
    'nodes': [{"name": "CreditCard_LogTxtCash advance 2", "id": 2}, {"name": "ChurningEvent 1", "id": 1}],
    'links': [{"source": {"name": "CreditCard_LogTxtCash advance 2", "id": 2}, "target": {"name": "CreditCard_LogTxtCash advance 1", "id": 1}, "value": 1479}],
    'sinksRight': false
  }
);
*/

d3.json("input/real_deep.json", function(error, json) {
  if (error) return console.warn(error);
  sankeyDraw(json);
});

</script>

<script type="text/javascript">

function updateInput(ish){
	console.log("Reload (the file need to be in input/...)")
	console.log(document.getElementById("theFile").files[0].name )
	
	document.title = document.getElementById("theFile").files[0].name;
	
	d3.json("input/"+document.getElementById("theFile").files[0].name, function(error, json) {
	  if (error) return console.warn(error);
	  
	  linksGroup.remove();
	  nodesGroup.remove();
	  svg.remove();
	  document.getElementsByTagName("svg")[0].remove();
	  
	// SVG (group) to draw in.
	svg = d3.select("#chart").append("svg")
	  .attr({
		width: width + margin.left + margin.right,
		height: height + margin.top + margin.bottom
	  })
	  .append("g")
	  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	linksGroup = svg.append("g").attr('class', 'links');
	nodesGroup = svg.append("g").attr('class', 'nodes');
	  
	  sankeyDraw(json);
	  	  
	});
}
</script>
<input type="file" id="theFile" onchange="updateInput(this.value)" size="40" style="width: 500px;"/>


</body>
</html>